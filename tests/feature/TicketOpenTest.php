<?php

namespace Aviator\Helpdesk\Tests\Feature;

use Aviator\Helpdesk\Tests\User;
use Aviator\Helpdesk\Models\Agent;
use Aviator\Helpdesk\Models\Ticket;
use Aviator\Helpdesk\Tests\TestCase;

class TicketOpenTest extends TestCase
{
    /**
     * @group feature
     * @group feature.tickets
     * @group feature.tickets.openings
     * @test
     */
    public function a_guest_cannot_open()
    {
        $response = $this->call('POST', 'helpdesk/tickets/open/' . factory(Ticket::class)->create()->id);

        $this->assertRedirectedTo('login');
    }

    /**
     * @group feature
     * @group feature.tickets
     * @group feature.tickets.openings
     * @test
     */
    public function a_user_cannot_open_someone_elses_ticket()
    {
        $this->be(factory(User::class)->create());
        $response = $this->call('POST', 'helpdesk/tickets/open/' . factory(Ticket::class)->create()->id);

        $this->assertResponseStatus(403);
    }

    /**
     * @group feature
     * @group feature.tickets
     * @group feature.tickets.openings
     * @test
     */
    public function a_user_can_reopen_their_own_ticket()
    {
        $user = factory(User::class)->create();
        $ticket = factory(Ticket::class)->create([
            'user_id' => $user->id,
        ]);

        $this->be($user);
        $ticket->close(null, $user);
        $response = $this->call('POST', 'helpdesk/tickets/open/' . $ticket->id);

        $ticket = $ticket->fresh();

        $this->assertRedirectedTo('helpdesk/tickets/' . $ticket->id);
        $this->assertTrue($ticket->isOpen());
        $this->assertEquals(2, $ticket->openings->count());
    }

    /**
     * @group feature
     * @group feature.tickets
     * @group feature.tickets.openings
     * @test
     */
    public function an_agent_cannot_close_an_unassigned_ticket()
    {
        $agent = factory(Agent::class)->create();
        $ticket = factory(Ticket::class)->create();

        $this->be($agent->user);
        $response = $this->call('POST', 'helpdesk/tickets/open/' . $ticket->id);

        $this->assertResponseStatus(403);
    }

    /**
     * @group feature
     * @group feature.tickets
     * @group feature.tickets.openings
     * @test
     */
    public function an_agent_can_close_an_assigned_ticket()
    {
        $agent = factory(Agent::class)->create();
        $ticket = factory(Ticket::class)->create()->assignToAgent($agent);

        $this->be($agent->user);
        $ticket->close(null, $agent);
        $response = $this->call('POST', 'helpdesk/tickets/open/' . $ticket->id, [
            'note' => 'test body',
        ]);

        $ticket = $ticket->fresh();

        $this->assertRedirectedTo('helpdesk/tickets/' . $ticket->id);
        $this->assertTrue($ticket->isOpen());
        $this->assertEquals('test body', $ticket->opening->note);
        $this->assertEquals(2, $ticket->openings->count());
    }
}
